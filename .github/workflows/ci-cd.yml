name: CI/CD for Spring Boot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build JAR
      run: ./gradlew clean build -x test

    - name: Setup SSH key
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      run: |
        echo "$DEPLOY_KEY" > $HOME/key.pem
        chmod 400 $HOME/key.pem

    - name: Deploy to EC2
      run: |
        # Copy JAR to EC2
        scp -o StrictHostKeyChecking=no -i $HOME/key.pem build/libs/*.jar ubuntu@ec2-3-92-62-56.compute-1.amazonaws.com:/home/ubuntu/deployment/
        
        # Restart services
        ssh -o StrictHostKeyChecking=no -i $HOME/key.pem ubuntu@ec2-3-92-62-56.compute-1.amazonaws.com '
          sudo systemctl restart helloworld &&
          sudo systemctl restart nginx
        '